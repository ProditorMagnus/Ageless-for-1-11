#textdomain wesnoth-Ageless_Era

# written on 4.08.2014 by Ravana

#define ABILITY_AE_RUNELAYING_2
    #Note: this is deliberately unbalanced WML, in order
    # to close the abilities clause then insert the event
    # then reopen the abilities clause.
    [dummy]
        id=AE_imp_runelaying_2
        name= _ "runelaying"
        description= _ "
This unit will draw a random rune on its hex at the beginning of its turn that will last for two turns. Each rune provides a different bonus."
    [/dummy]
[/abilities]
	[event]
		name=turn_refresh
		first_time_only=no
		id=AE_imp_runelaying_2_turn_refresh
		[store_unit]
			[filter]
				ability=AE_imp_runelaying_2
				side=$side_number
			[/filter]
			variable=runelayers
		[/store_unit]
	#healing spot +4/+8 - can be reapplied, cures
	#max hp +2/+4
	#resistances +15/+30 all resists
	#damage +2/+4
	#chance to hit +10/+20
	#def +10/+20
	#nothing with 2-3 times probability - less likely for level 3
		{FOREACH runelayers i}
		[if]
			[variable]
				name=AE_imp_no_rune$runelayers[$i].x|_$runelayers[$i].y|
				not_equals=1
			[/variable]
			[then]
				#[chat]
				#	message="placed rune"
				#[/chat]
				{AE_RUNE_EFFECT_2}
				[set_variable]
					name=runelayers[$j].status.AE_imp_status_runed
					value=no
				[/set_variable]
				[unstore_unit]
					variable=runelayers[$j]
					find_vacant=no
				[/unstore_unit]
				#{DEBUG_MSG $AE_imp_active_runes_2[0].end_turn}
				#generate a random rune that lasts {DURATION} turns
			[/then]
		[/if]
		{NEXT i}
		{CLEAR_VARIABLE runelayers}
		{FOREACH AE_imp_active_runes_2 i}

			#[chat]
			#	message=_"added object"
			#[/chat]
			[object]
				id=rune$AE_imp_active_runes_2[$i].x|_$AE_imp_active_runes_2[$i].y|_$turn_number|_$side_number|
				silent=yes
				name=_"runelaying_rune_2"
				[filter]
					x=$AE_imp_active_runes_2[$i].x
					y=$AE_imp_active_runes_2[$i].y
					side=$side_number
					[not]
						[filter_wml]
							[status]
								AE_imp_status_runed=yes
							[/status]
						[/filter_wml]
					[/not]
				[/filter]
				{INSERT_EFFECT AE_imp_active_runes_2[$i].effect}
				[effect]
					apply_to=status
					add=AE_imp_status_runed
				[/effect]
			[/object]
			[label]
				x=$AE_imp_active_runes_2[$i].x
				y=$AE_imp_active_runes_2[$i].y
				text=$AE_imp_active_runes_2[$i].label
				color=$AE_imp_active_runes_2[$i].rgb
			[/label]
			[if]
				[have_unit]
					x=$AE_imp_active_runes_2[$i].x
					y=$AE_imp_active_runes_2[$i].y
				[/have_unit]
				[then]
					[store_unit]
						[filter]
							x=$AE_imp_active_runes_2[$i].x
							y=$AE_imp_active_runes_2[$i].y
						[/filter]
						variable=placed_unit
						kill=no
					[/store_unit]
					[if]
						[variable]
							name=placed_unit.side
							not_equals=$AE_imp_active_runes_2[$i].side
						[/variable]
						[then]
							[label]
								x=$AE_imp_active_runes_2[$i].x
								y=$AE_imp_active_runes_2[$i].y
								text=""
								immutable=no
							[/label]
							{CLEAR_VARIABLE AE_imp_active_runes_2[$i]}
							#[chat]
							#	message=_"destroyed"
							#[/chat]
						[/then]
					[/if]
				[/then]
			[/if]
		{NEXT i}
	[/event]

	[event]
		name=side_turn
		first_time_only=no
		id=AE_imp_runelaying_2_side_turn
		{FOREACH AE_imp_active_runes_2 i}
			#[chat]
			#	message=_"loop $i"
			#[/chat]
			{VARIABLE AE_imp_no_rune$AE_imp_active_runes_2[$i].x|_$AE_imp_active_runes_2[$i].y| 1}
			[if]
				[variable]
					name=AE_imp_active_runes_2[$i].end_turn
					equals=$turn_number
				[/variable]
				[then]
					#[chat]
					#	message=_"removed rune"
					#[/chat]
					#{VARIABLE last_turn $turn_number}
					#{VARIABLE_OP last_turn sub 1}
					[label]
						x=$AE_imp_active_runes_2[$i].x
						y=$AE_imp_active_runes_2[$i].y
						text=""
						immutable=no
					[/label]
					{AE_REMOVE_OBJECT (x,y=$AE_imp_active_runes_2[$i].x,$AE_imp_active_runes_2[$i].y) runelaying_rune_2}
					#{VARIABLE_OP last_turn sub 1}
					#{AE_REMOVE_OBJECT (x,y=$AE_imp_active_runes_2[$i].x,$AE_imp_active_runes_2[$i].y) rune$AE_imp_active_runes_2[$i].x|_$AE_imp_active_runes_2[$i].y|n}
					#{VARIABLE_OP last_turn sub 1}
					#{AE_REMOVE_OBJECT (x,y=$AE_imp_active_runes_2[$i].x,$AE_imp_active_runes_2[$i].y) rune$AE_imp_active_runes_2[$i].x|_$AE_imp_active_runes_2[$i].y|}
					[store_unit]
						[filter]
							x,y=$AE_imp_active_runes_2[$i].x,$AE_imp_active_runes_2[$i].y
						[/filter]
						variable=unit_to_unrune
						kill=no
					[/store_unit]
					[set_variable]
						name=unit_to_unrune.status.AE_imp_status_runed
						value=no
					[/set_variable]
					[unstore_unit]
						variable=unit_to_unrune
						find_vacant=no
					[/unstore_unit]
					{CLEAR_VARIABLE unit_to_unrune}
					{CLEAR_VARIABLE AE_imp_no_rune$AE_imp_active_runes_2[$i].x|_$AE_imp_active_runes_2[$i].y|}
					{CLEAR_VARIABLE AE_imp_active_runes_2[$i]}
					#[chat]
					#	message=_"cleared AE_imp_no_rune$AE_imp_active_runes_2[$i].x|_$AE_imp_active_runes_2[$i].y|"
					#[/chat]
				[/then]
			[/if]

		{NEXT i}
	[/event]
	[event]
		name=moveto
		first_time_only=no
		id=AE_imp_runelaying_2_moveto
		#[chat]
		#	message=_"moveto"
		#[/chat]
		{AE_REMOVE_OBJECT (x,y=$x1,$y1) runelaying_rune_2}
		[set_variable]
			name=unit.status.AE_imp_status_runed
			value=no
		[/set_variable]
		[unstore_unit]
			variable=unit
			find_vacant=no
		[/unstore_unit]
		#{VARIABLE last_turn $turn_number}
		#{VARIABLE_OP last_turn sub 1}
		#{AE_REMOVE_OBJECT (x,y=$x1,$y1) rune$x2|_$y2|}
		#{VARIABLE_OP last_turn sub 1}
		#{AE_REMOVE_OBJECT (x,y=$x1,$y1) rune$x2|_$y2|}
		#{VARIABLE_OP last_turn sub 1}
		#{AE_REMOVE_OBJECT (x,y=$x1,$y1) rune$x2|_$y2|_$last_turn}
		#remove effects other than heal
	[/event]
[+abilities]
#enddef
